name: Multiplatform Build & Release

on:
  push:
    branches: [ "**" ]
  release:
    types: [ published ]
  workflow_dispatch:

jobs:
  # ----------------------------------------------------------------
  # Android Build Job
  # ----------------------------------------------------------------
  android_build:
    name: Android Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Create local.properties
        env:
          APP_ENV: ${{ secrets.APP_ENV }}
          IGDB_API_URL: ${{ secrets.IGDB_API_URL }}
          GAMERLOGUE_URL: ${{ secrets.GAMERLOGUE_URL }}
        run: |
          touch local.properties
          echo "APP_ENV=$APP_ENV" >> local.properties
          echo "IGDB_API_URL=$IGDB_API_URL" >> local.properties
          echo "GAMERLOGUE_URL=$GAMERLOGUE_URL" >> local.properties

      # Decode Keystore for Release builds
      - name: Decode Keystore
        if: github.event_name == 'release'
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > release.keystore

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # Build APK (Debug) for every push
      - name: Build APK (Debug)
        if: github.event_name != 'release'
        run: ./gradlew :androidApp:assembleDebug

      - name: Upload Debug APK
        if: github.event_name != 'release'
        uses: actions/upload-artifact@v4
        with:
          name: android-debug-apk
          path: androidApp/build/outputs/apk/debug/*.apk

      # Build Signed Release Bundle/APK for Release
      - name: Build Release Bundle & APK
        if: github.event_name == 'release'
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_KEYSTORE_PATH: release.keystore
        run: ./gradlew :androidApp:bundleRelease :androidApp:assembleRelease

      - name: Upload Release Artifacts
        if: github.event_name == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: |
            androidApp/build/outputs/apk/release/*.apk
            androidApp/build/outputs/bundle/release/*.aab

      # Publish to Play Store
      - name: Publish to Play Store
        if: github.event_name == 'release'
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_JSON_KEY }}
          packageName: com.maicol07.gamerlogue # Update with actual package name if different
          releaseFiles: androidApp/build/outputs/bundle/release/*.aab
          track: ${{ github.event.release.prerelease && 'beta' || 'production' }}
          status: completed

  # ----------------------------------------------------------------
  # Desktop Build Job (Matrix)
  # ----------------------------------------------------------------
  desktop_build:
    name: Desktop Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      # Windows specific setup (sometimes needed for WiX, but usually pre-installed)

      - name: Create local.properties
        shell: bash
        env:
          APP_ENV: ${{ secrets.APP_ENV }}
          IGDB_API_URL: ${{ secrets.IGDB_API_URL }}
          GAMERLOGUE_URL: ${{ secrets.GAMERLOGUE_URL }}
        run: |
          touch local.properties
          echo "APP_ENV=$APP_ENV" >> local.properties
          echo "IGDB_API_URL=$IGDB_API_URL" >> local.properties
          echo "GAMERLOGUE_URL=$GAMERLOGUE_URL" >> local.properties

      - name: Grant execute permission for gradlew
        if: runner.os != 'Windows'
        run: chmod +x gradlew

      - name: Build Desktop App (Linux Deb)
        if: runner.os == 'Linux'
        run: ./gradlew :desktopApp:packageDeb

      - name: Build Desktop App (Windows Exe)
        if: runner.os == 'Windows'
        run: ./gradlew :desktopApp:packageExe

      - name: Build Desktop App (macOS Dmg)
        if: runner.os == 'macOS'
        run: ./gradlew :desktopApp:packageDmg

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ runner.os }}
          path: |
             desktopApp/build/compose/binaries/main/deb/*.deb
             desktopApp/build/compose/binaries/main/exe/*.exe
             desktopApp/build/compose/binaries/main/dmg/*.dmg
          if-no-files-found: ignore

  # ----------------------------------------------------------------
  # Web Build Job
  # ----------------------------------------------------------------
  web_build:
    name: Web Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Create local.properties
        env:
          APP_ENV: ${{ secrets.APP_ENV }}
          IGDB_API_URL: ${{ secrets.IGDB_API_URL }}
          GAMERLOGUE_URL: ${{ secrets.GAMERLOGUE_URL }}
        run: |
          touch local.properties
          echo "APP_ENV=$APP_ENV" >> local.properties
          echo "IGDB_API_URL=$IGDB_API_URL" >> local.properties
          echo "GAMERLOGUE_URL=$GAMERLOGUE_URL" >> local.properties

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Web Distribution
        run: ./gradlew :webApp:composeCompatibilityBrowserDistribution

      - name: Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-app
          path: webApp/build/dist/composeWebCompatibility/productionExecutable/

      - name: Deploy to GitHub Pages
        if: github.event_name == 'release'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: webApp/build/dist/composeWebCompatibility/productionExecutable

  # ----------------------------------------------------------------
  # Release Assets Job
  # ----------------------------------------------------------------
  release_assets:
    name: Upload Release Assets
    needs: [android_build, desktop_build, web_build]
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*'
          merge-multiple: true
          path: artifacts

      - name: Display downloaded files
        run: ls -R artifacts

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*

